<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8">
<title>Registro Dinâmico</title>
<style>
  table { border-collapse: collapse; }
  td, th { padding: 5px; border: 1px solid #000; text-align: center; }
  input { width: 60px; }
</style>
</head>
<body>
<h2>Registro de Dados</h2>
<form id="formDados">
  Data: <input type="date" name="data" required><br><br>
  Idade (anos): <input type="number" name="idade" required><br><br>

  <table id="tabelaMunicipios">
    <thead>
      <tr>
        <th>Município</th><th>Comunidade</th><th>Escola</th><th>Posto Fixo</th><th>Subtotal</th>
      </tr>
    </thead>
    <tbody>
      <!-- Linhas serão inseridas dinamicamente -->
    </tbody>
    <tfoot>
      <tr>
        <td colspan="4">Total Geral</td>
        <td><input type="number" name="total" value="0" readonly></td>
      </tr>
    </tfoot>
  </table><br>

  <button type="submit">Enviar</button>
</form>

<script>
const municipios = ["Mecunica","Mepuera","Metarica","Muhemela","Nacumua","Namicunde","Niputa"];
const tbody = document.querySelector("#tabelaMunicipios tbody");

municipios.forEach(m => {
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td>${m}</td>
    <td><input type="number" name="${m}_comunidade" value="0"></td>
    <td><input type="number" name="${m}_escola" value="0"></td>
    <td><input type="number" name="${m}_posto" value="0"></td>
    <td><input type="number" name="${m}_subtotal" value="0" readonly></td>
  `;
  tbody.appendChild(tr);
});

const form = document.getElementById('formDados');

function calcularSubtotais() {
  let totalGeral = 0;
  municipios.forEach(m => {
    const c = Number(form[`${m}_comunidade`].value) || 0;
    const e = Number(form[`${m}_escola`].value) || 0;
    const p = Number(form[`${m}_posto`].value) || 0;
    const subtotal = c + e + p;
    form[`${m}_subtotal`].value = subtotal;
    totalGeral += subtotal;
  });
  form['total'].value = totalGeral;
}

// Recalcular subtotais ao mudar valores
form.querySelectorAll('input[type=number]').forEach(input => {
  input.addEventListener('input', calcularSubtotais);
});

form.addEventListener('submit', e => {
  e.preventDefault();
  calcularSubtotais();
  
  const dataEnvio = {
    data: form.data.value,
    idade: form.idade.value,
    municipios: municipios.map(m => ({
      nome: m,
      comunidade: Number(form[`${m}_comunidade`].value) || 0,
      escola: Number(form[`${m}_escola`].value) || 0,
      posto: Number(form[`${m}_posto`].value) || 0,
      subtotal: Number(form[`${m}_subtotal`].value) || 0
    })),
    total: Number(form.total.value) || 0
  };

  fetch('SUA_URL_DO_SCRIPT', { // substitua pela URL do Apps Script
    method: 'POST',
    body: JSON.stringify(dataEnvio)
  })
  .then(res => res.json())
  .then(res => {
    if(res.result === "success") alert('Dados enviados com sucesso!');
    else alert('Erro: '+res.message);
    form.reset();
    calcularSubtotais();
  })
  .catch(err => alert('Erro: '+err));
});
</script>
</body>
</html>
