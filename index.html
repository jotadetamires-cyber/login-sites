<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastro de Produto</title>
    <style>
        body { font-family: sans-serif; max-width: 600px; margin: 20px auto; }
        form { display: flex; flex-direction: column; gap: 10px; }
        input { padding: 8px; font-size: 1rem; }
        button { padding: 12px; font-size: 1rem; background-color: #28a745; color: white; border: none; cursor: pointer; }
        button:hover { background-color: #218838; }
        #status { margin-top: 15px; font-weight: bold; }
        /* Estilo para a área de assinatura */
        #signature-pad {
            border: 1px solid #ccc;
            background-color: #fff;
            cursor: crosshair;
            margin-top: 10px;
        }
        #signature-preview {
            margin-top: 10px;
            border: 1px solid #eee;
            max-width: 100%;
            height: auto;
            display: none; /* Escondido por padrão */
        }
    </style>
</head>
<body>
    
    <h1>Cadastro de Produto</h1>
    <form id="productForm">
        <label for="nomeProduto">Nome do Produto:</label>
        <input type="text" id="nomeProduto" name="Nome do Produto" required>

        <label for="quantidade">Quantidade:</label>
        <input type="number" id="quantidade" name="Quantidade">

        <label for="precoCompra">Preço de Compra:</label>
        <input type="number" step="0.01" id="precoCompra" name="Preço de Compra">

        <label for="precoVenda">Preço de Venda:</label>
        <input type="number" step="0.01" id="precoVenda" name="Preço de Venda">

        <label for="assinatura">Assinatura:</label>
        <canvas id="signature-pad" width="400" height="200"></canvas>
        <button type="button" id="clear-signature">Limpar Assinatura</button>
        <button type="button" id="preview-signature">Pré-visualizar Assinatura</button>
        <img id="signature-preview" src="#" alt="Pré-visualização da Assinatura">
        <input type="hidden" id="assinatura" name="Assinatura"> <button type="submit" id="submit-button">Salvar</button>
    </form>
    
    <div id="status"></div>

    <script>
        // ######################################################################
        // ## COLE A URL DO SEU SCRIPT PUBLICADO AQUI DENTRO DAS ASPAS      ##
        // ######################################################################
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxb3Ekya4ZMKN6osOnlfdZA1PXLzp-vcxdsW8XzVdOeVztJsjEp0bN20z5_bouwNg0/exec";

        const form = document.getElementById('productForm');
        const statusDiv = document.getElementById('status');
        const submitButton = document.getElementById('submit-button');

        // Elementos da assinatura
        const signaturePadCanvas = document.getElementById('signature-pad');
        const clearSignatureButton = document.getElementById('clear-signature');
        const previewSignatureButton = document.getElementById('preview-signature');
        const signaturePreviewImg = document.getElementById('signature-preview');
        const signatureHiddenInput = document.getElementById('assinatura');
        
        const signaturePad = new SignaturePad(signaturePadCanvas);

        // Esta parte do código lê os dados da URL quando a página carrega
        window.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            
            // Preenche os campos do formulário com os dados da URL
            document.getElementById('nomeProduto').value = urlParams.get('nomeProduto') || '';
            document.getElementById('quantidade').value = urlParams.get('quantidade') || '';
            document.getElementById('precoCompra').value = urlParams.get('precoCompra') || '';
            document.getElementById('precoVenda').value = urlParams.get('precoVenda') || '';
        });

        // Eventos para o pad de assinatura
        clearSignatureButton.addEventListener('click', () => {
            signaturePad.clear();
            signaturePreviewImg.style.display = 'none'; // Esconde a pré-visualização
            signatureHiddenInput.value = ''; // Limpa o valor do input hidden
        });

        previewSignatureButton.addEventListener('click', () => {
            if (!signaturePad.isEmpty()) {
                const dataURL = signaturePad.toDataURL(); // Pega a assinatura como URL de dados
                signaturePreviewImg.src = dataURL;
                signaturePreviewImg.style.display = 'block'; // Mostra a imagem de pré-visualização
            } else {
                alert('Por favor, faça uma assinatura antes de pré-visualizar.');
                signaturePreviewImg.style.display = 'none';
                signatureHiddenInput.value = '';
            }
        });

        // Esta parte envia os dados para a planilha quando o formulário é submetido
        form.addEventListener('submit', e => {
            e.preventDefault(); // Impede o recarregamento da página

            submitButton.disabled = true;
            statusDiv.textContent = 'Enviando, por favor aguarde...';

            const formData = new FormData(form);
            const data = {};
            // Converte os dados do formulário para um objeto simples
            formData.forEach((value, key) => (data[key] = value));

            // Adiciona a assinatura aos dados se ela existir
            if (!signaturePad.isEmpty()) {
                data['Assinatura'] = signaturePad.toDataURL(); // Converte a assinatura para Data URL
            } else {
                data['Assinatura'] = ''; // Envia vazio se não houver assinatura
            }

            fetch(SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify(data),
            })
            .then(response => response.json())
            .then(result => {
                statusDiv.textContent = result.message;
                if(result.status === 'success') {
                    statusDiv.style.color = 'green';
                    form.reset(); // Limpa o formulário após o sucesso
                    signaturePad.clear(); // Limpa o pad de assinatura
                    signaturePreviewImg.style.display = 'none'; // Esconde a pré-visualização
                    signatureHiddenInput.value = ''; // Limpa o input hidden da assinatura
                } else {
                    statusDiv.style.color = 'red';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                statusDiv.textContent = 'Ocorreu um erro grave. Verifique o console (F12).';
                statusDiv.style.color = 'red';
            })
            .finally(() => {
                submitButton.disabled = false; // Reativa o botão
            });
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.0/dist/signature_pad.umd.min.js"></script>
</body>
</html>
