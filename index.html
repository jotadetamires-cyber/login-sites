<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <title>Controlo de Fornecimentos</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f7fa;
      padding: 20px;
    }
    h1 { text-align: center; color: #333; }
    form, .filtros {
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      margin-bottom: 20px;
      max-width: 800px;
      margin-left: auto;
      margin-right: auto;
    }
    label { display: block; margin-top: 10px; }
    input, select, button {
      width: 100%;
      padding: 8px;
      margin-top: 5px;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: #fff;
    }
    th, td {
      padding: 10px;
      border: 1px solid #ccc;
      text-align: center;
    }
    th { background: #007bff; color: #fff; }
    .btnPago {
      background: #28a745;
      color: #fff;
      border: none;
      padding: 5px 10px;
      border-radius: 4px;
      cursor: pointer;
    }
    .btnPago:hover { background: #218838; }
    .acoes { text-align: center; margin-top: 20px; }
    .acoes button {
      width: auto;
      margin: 5px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 8px 16px;
      cursor: pointer;
    }
    .acoes button:hover { background: #0056b3; }
  </style>
</head>
<body>

  <h1>📊 Controlo de Fornecimentos</h1>

  <!-- Formulário de cadastro -->
  <form id="formFornecimento">
    <label>Fornecedor: <input type="text" id="fornecedor" required></label>
    <label>Beneficiário: <input type="text" id="beneficiario" required></label>
    <label>Material: <input type="text" id="material" required></label>
    <label>Quantidade: <input type="number" id="quantidade" step="0.01" required></label>
    <label>Preço Unitário (MT): <input type="number" id="precoUnitario" step="0.01" required></label>
    <label>Status:
      <select id="status" required>
        <option value="Pago">Pago</option>
        <option value="Não Pago">Não Pago</option>
      </select>
    </label>
    <button type="submit">💾 Salvar</button>
  </form>

  <!-- Filtros para relatório -->
  <div class="filtros">
    <h3>📑 Filtros para Relatório</h3>
    <label>Data Início: <input type="date" id="dataInicio"></label>
    <label>Data Fim: <input type="date" id="dataFim"></label>
    <label>Status:
      <select id="filtroStatus">
        <option value="">Todos</option>
        <option value="Pago">Pago</option>
        <option value="Não Pago">Não Pago</option>
      </select>
    </label>
    <div class="acoes">
      <button id="gerarPDF">Gerar PDF</button>
      <button id="carregarNaoPagos">Carregar Não Pagos</button>
    </div>
  </div>

  <!-- Tabela de dados -->
  <table>
    <thead>
      <tr>
        <th>Data</th>
        <th>Fornecedor</th>
        <th>Beneficiário</th>
        <th>Material</th>
        <th>Qtd</th>
        <th>Preço Unit</th>
        <th>Total</th>
        <th>Status</th>
        <th>Ação</th>
      </tr>
    </thead>
    <tbody id="tabelaFornecimentos"></tbody>
  </table>

  <!-- ===================== JAVASCRIPT ===================== -->
  <script>
    const form        = document.getElementById('formFornecimento');
    const tabela      = document.getElementById('tabelaFornecimentos');
    const gerarPDF    = document.getElementById('gerarPDF');
    const btnNaoPagos = document.getElementById('carregarNaoPagos');

    let fornecimentos = JSON.parse(localStorage.getItem('fornecimentos')) || [];

    // 🚨 Substitua pela URL do seu Apps Script publicado
    const scriptURL = "https://script.google.com/macros/s/AKfycbyTdvKv5Y9FLbJ8eAliB6q4Xe1amtOb-kATjPig_5tYP1db1Xbv3oBH4IzOeizHUPMG/exec";

    function salvarLocal(){
      localStorage.setItem('fornecimentos', JSON.stringify(fornecimentos));
    }

    function formatarDataISO(dataISO){
      return new Date(dataISO).toLocaleDateString('pt-PT');
    }

    function parseData(str){
      if (/^\\d{4}-\\d{2}-\\d{2}$/.test(str)) return new Date(str + "T00:00:00");
      if (/^\\d{2}\\/\\d{2}\\/\\d{4}$/.test(str)){
        const [d,m,a] = str.split('/');
        return new Date(`${a}-${m}-${d}T00:00:00`);
      }
      return new Date(str);
    }

    function atualizarTabela(){
      tabela.innerHTML = '';
      fornecimentos.forEach((item,idx)=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${formatarDataISO(item.data)}</td>
          <td>${item.fornecedor}</td>
          <td>${item.beneficiario}</td>
          <td>${item.material}</td>
          <td>${item.quantidade}</td>
          <td>${item.precoUnitario.toFixed(2)}</td>
          <td>${item.precoTotal}</td>
          <td>${item.status}</td>
          <td>${item.status==='Não Pago'
              ? `<button class="btnPago" data-idx="${idx}" data-row="${item.row||''}">Marcar Pago</button>`
              : ''}</td>`;
        tabela.appendChild(tr);
      });

      document.querySelectorAll('.btnPago').forEach(btn=>{
        btn.onclick = async ()=>{
          const i    = btn.dataset.idx;
          const linhaSheet = btn.dataset.row;
          fornecimentos[i].status = 'Pago';
          salvarLocal();
          atualizarTabela();

          if(linhaSheet){
            await fetch(scriptURL,{
              method:"POST",
              headers:{"Content-Type":"application/json"},
              body: JSON.stringify({
                action:"update",
                row: linhaSheet,
                status:"Pago"
              })
            });
          } else {
            await fetch(scriptURL,{
              method:"POST",
              headers:{"Content-Type":"application/json"},
              body: JSON.stringify(fornecimentos[i])
            });
          }
        };
      });
    }

    form.onsubmit = e=>{
      e.preventDefault();
      const fornecedor   = document.getElementById('fornecedor').value;
      const beneficiario = document.getElementById('beneficiario').value;
      const material     = document.getElementById('material').value;
      const quantidade   = parseFloat(document.getElementById('quantidade').value);
      const precoUnit    = parseFloat(document.getElementById('precoUnitario').value);
      const status       = document.getElementById('status').value;

      const precoTotal = (quantidade * precoUnit).toFixed(2);
      const data = new Date().toISOString().split('T')[0];

      const novo = { fornecedor, beneficiario, material,
                     quantidade, precoUnitario:precoUnit,
                     precoTotal, status, data };

      fornecimentos.push(novo);
      salvarLocal();
      atualizarTabela();
      form.reset();

      fetch(scriptURL,{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify(novo)
      });
    };

    btnNaoPagos.onclick = async ()=>{
      try{
        const r = await fetch(scriptURL);
        const lista = await r.json();
        fornecimentos = lista.filter(x=>x.status === 'Não Pago');
        salvarLocal();
        atualizarTabela();
      }catch(e){ alert('Erro ao carregar registros.'); console.error(e); }
    };

    gerarPDF.onclick = async ()=>{
      try{
        const r = await fetch(scriptURL);
        const lista = await r.json();
        const inicio = document.getElementById('dataInicio').value;
        const fim    = document.getElementById('dataFim').value;
        const fStatus= document.getElementById('filtroStatus').value;

        const filtrados = lista.filter(item=>{
          let ok = true;
          const d = parseData(item.data);
          if (inicio && d < new Date(inicio+"T00:00:00")) ok=false;
          if (fim    && d > new Date(fim+"T23:59:59")) ok=false;
          if (fStatus && item.status !== fStatus) ok=false;
          return ok;
        });

        if (!filtrados.length){ alert('Nenhum registro no período.'); return; }

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({orientation:'landscape'});
        doc.setFontSize(14);
        doc.text("Relatório de Fornecimentos",14,15);

        const cabec = ["Data","Fornecedor","Beneficiário","Material",
                       "Qtd","Preço Unit","Total","Status"];
        const corpo = filtrados.map(x=>[
          formatarDataISO(x.data), x.fornecedor, x.beneficiario, x.material,
          x.quantidade, x.precoUnitario, x.precoTotal, x.status
        ]);
        const total = filtrados.reduce((s,x)=>s+parseFloat(x.precoTotal),0).toFixed(2);

        doc.autoTable({
          head:[cabec],
          body:corpo,
          startY:25,
          styles:{fontSize:8},
          foot:[['','','','','','Total Geral',total+' MT','']]
        });

        doc.save("Relatorio_Fornecimentos.pdf");
      }catch(e){ alert('Erro ao gerar PDF.'); console.error(e); }
    };

    atualizarTabela();
  </script>
</body>
</html>
